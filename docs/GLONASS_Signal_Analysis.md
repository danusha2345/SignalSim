# Детальный анализ цепочки генерации сигнала ГЛОНАСС

## Обнаруженные проблемы

### 1. Отсутствие меандра 100 Гц

**Проблема:** В текущей реализации полностью отсутствует вспомогательный меандр 100 Гц, который является обязательным компонентом сигнала ГЛОНАСС согласно ICD.

**Согласно ICD ГЛОНАСС:**
- Сигнал формируется путём сложения по модулю 2 трёх компонентов:
  1. ПС дальномерный код 511 кбит/с
  2. Навигационное сообщение 50 бит/с
  3. Вспомогательный меандр 100 Гц

**В коде:**
- Генерируется только ПС код и навигационное сообщение
- Меандр 100 Гц не генерируется и не применяется

**Влияние:** Без меандра приёмники не смогут корректно демодулировать сигнал ГЛОНАСС.

### 2. Правильность модуляции данных

**Анализ полярности:**
В коде используется правильная полярность BPSK модуляции:
```cpp
DataBit = (DataBits[BitNumber] ? -1 : 1);
```
- Бит 1 → -1 (инверсия фазы на 180°)
- Бит 0 → +1 (без инверсии)

Это соответствует стандартной BPSK модуляции.

### 3. Структура временной метки

**В коде реализовано:**
```cpp
// Временная метка: 111110001101110101000010010110b = 0x3E375096
const unsigned int TIME_MARK = 0x3E375096;
```

**Проблема:** Временная метка модулируется без учёта меандра 100 Гц.

### 4. Навигационное сообщение

**Текущая реализация:**
- Каждая строка: 2000 мс
- Временная метка: 300 мс (30 бит × 10 мс)
- Навигационные данные: 1700 мс (100 бит)

**Проблема расчёта битовой позиции:**
```cpp
BitNumber = (StringPosition - 300) * 100 / 1700;  // 100 бит за 1700 мс
```
Это даёт неравномерное распределение: ~58.8 мкс на бит вместо 20 мс.

### 5. Отсутствие интеграции меандра в модуляцию

**Должно быть согласно ICD:**
```
Модулированный сигнал = ПС код ⊕ Навигационные данные ⊕ Меандр 100 Гц
```

**В коде:**
```
Модулированный сигнал = ПС код × Навигационные данные
```

## Необходимые исправления

### 1. Добавить генерацию меандра 100 Гц

```cpp
// Генерация меандра 100 Гц (период 10 мс)
int GetMeander100Hz(GNSS_TIME TransmitTime)
{
    // Меандр меняет значение каждые 5 мс
    // 0-5 мс: 0, 5-10 мс: 1, 10-15 мс: 0, и т.д.
    return ((TransmitTime.MilliSeconds % 10) < 5) ? 0 : 1;
}
```

### 2. Применить меандр к сигналу

```cpp
// В SatelliteSignal::GetSatelliteSignal для ГЛОНАСС
if (SatSystem == GlonassSystem && (SatSignal == SIGNAL_INDEX_G1 || SatSignal == SIGNAL_INDEX_G2))
{
    int meander = GetMeander100Hz(TransmitTime);
    // Применить меандр через XOR (сложение по модулю 2)
    if (meander)
        DataBit = -DataBit;  // Инверсия при меандре = 1
}
```

### 3. Исправить расчёт битовой позиции

```cpp
// Правильный расчёт: 50 бит/с = 20 мс на бит
int msInString = StringPosition - 300;  // мс от начала навигационных данных
BitNumber = msInString / 20;  // 20 мс на бит
if (BitNumber >= 85) BitNumber = 84;  // Защита (85 информационных бит)
```

### 4. Добавить меандр к временной метке

```cpp
// При передаче временной метки также применять меандр
if (StringPosition < 300)  // Временная метка
{
    int TimeMarkerBitIndex = StringPosition / 10;
    DataBit = (TimeMarkerBits[TimeMarkerBitIndex] ? -1 : 1);
    
    // Применить меандр
    int meander = GetMeander100Hz(TransmitTime);
    if (meander)
        DataBit = -DataBit;
}
```

## Правильная последовательность модуляции ГЛОНАСС

1. **Генерация компонентов:**
   - ПС код (PRN): 511 кбит/с
   - Навигационные данные: 50 бит/с (с временной меткой)
   - Меандр: 100 Гц

2. **Объединение по модулю 2:**
   ```
   Бит_данных ⊕ Чип_ПС_кода ⊕ Меандр = Результат
   ```

3. **BPSK модуляция:**
   - Результат = 0 → Фаза 0°
   - Результат = 1 → Фаза 180°

## Влияние на приёмники

Без меандра 100 Гц:
- Приёмники не смогут синхронизироваться с сигналом
- Невозможна демодуляция навигационного сообщения
- Нарушается спектральная характеристика сигнала

## Заключение

Основная проблема - полное отсутствие вспомогательного меандра 100 Гц, который является обязательным компонентом сигнала ГЛОНАСС. Без него сигнал не соответствует стандарту ICD ГЛОНАСС и не может быть правильно обработан приёмниками.