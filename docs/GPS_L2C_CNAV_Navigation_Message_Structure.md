# Структура навигационного сообщения GPS L2C CNAV

## Обзор

Сигнал GPS L2C передаёт сообщение CNAV (Civil Navigation - гражданская навигация), которое представляет модернизированный формат гражданского навигационного сообщения. CNAV обеспечивает улучшенную точность навигации, целостность и доступность по сравнению с устаревшим сообщением NAV на L1 C/A.

## Характеристики сигнала

- **Частота**: 1227.60 МГц
- **Модуляция**: 
  - L2 CM (Civil Moderate - гражданский умеренный): BPSK с данными
  - L2 CL (Civil Long - гражданский длинный): BPSK пилот (без данных)
- **Скорость передачи чипов**: 511.5 кчип/с (каждый)
- **Скорость передачи данных**: 25 бит/с (50 симв/с со скоростью FEC 1/2)
- **Длительность символа**: 20 мс
- **Длина сообщения**: 300 бит (12 секунд)
- **Прямое исправление ошибок**: Свёрточный код со скоростью 1/2

## Структура сообщения

```
Сообщение CNAV (300 бит, 12 секунд)
├── Преамбула (8 бит)
├── Номер PRN (6 бит)
├── ID типа сообщения (6 бит)
├── Время недели (17 бит)
├── Флаг тревоги (1 бит)
├── Переменное поле данных (238 бит - зависит от типа сообщения)
└── CRC (24 бита)
```

## Типы сообщений и их компоновка

CNAV определяет множество типов сообщений (MT), каждый из которых несёт различную информацию:

### Типы сообщений 10-11: Данные эфемерид

Эти два сообщения вместе содержат полные параметры эфемерид.

#### Содержимое типа сообщения 10:
- **Номер недели (WN)**: 13 бит
- **Состояние сигналов L1/L2/L5**: 3 бита
- **t_op**: 11 бит (интервал прогноза данных эфемерид)
- **t_oe**: 11 бит (время привязки эфемерид), масштаб: 300 секунд
- **Δt_LS**: 8 бит (текущие високосные секунды)
- **Δt_LSF**: 8 бит (будущие високосные секунды)
- **A_dot**: 25 бит (скорость изменения большой полуоси)
- **Δn_dot**: 17 бит (скорость изменения среднего движения)
- **URA_NED0**: 5 бит (точность дальности пользователя)
- **URA_NED1**: 3 бита
- **URA_NED2**: 3 бита

#### Содержимое типа сообщения 11:
- **t_oe**: 11 бит (должен совпадать с MT 10)
- **e**: 33 бита (эксцентриситет), масштаб: 2^-34
- **ω**: 33 бита (аргумент перигея), масштаб: 2^-32 полуокружностей
- **Δi**: 15 бит (смещение наклонения от 0.3 полуокружностей)
- **Ω_dot**: 17 бит (скорость прецессии), масштаб: 2^-44 полуокружностей/сек

### Тип сообщения 12: Сокращённый альманах

Содержит альманах пониженной точности для нескольких спутников (до 31).

**Параметры на спутник:**
- **PRN**: 8 бит
- **Δα**: 8 бит (отклонение широты)
- **λ_o**: 8 бит (долгота)
- **Состояние**: 1 бит

### Тип сообщения 13: Дифференциальная коррекция

Параметры дифференциальной коррекции часов для 7 спутников:
- **PRN_i**: 8 бит
- **Δa_f0**: 14 бит (коррекция смещения часов)
- **t_OD**: 11 бит (время данных)

### Тип сообщения 14: Данные эфемерид (продолжение)

Дополнительные параметры эфемерид:
- **C_uc**: 21 бит (косинусная амплитуда - аргумент широты)
- **C_us**: 21 бит (синусная амплитуда - аргумент широты)
- **C_rc**: 24 бита (косинусная амплитуда - радиус орбиты)
- **C_rs**: 24 бита (синусная амплитуда - радиус орбиты)
- **C_ic**: 21 бит (косинусная амплитуда - наклонение)
- **C_is**: 21 бит (синусная амплитуда - наклонение)

### Тип сообщения 15: Текстовое сообщение

- **Текст**: 29 символов (8 бит каждый)
- **Номер страницы**: 4 бита

### Тип сообщения 30: Часы, ионосфера и групповая задержка

Параметры часов:
- **t_oc**: 11 бит (время привязки данных часов), масштаб: 300 секунд
- **a_f0**: 26 бит (смещение часов), масштаб: 2^-35 секунд
- **a_f1**: 20 бит (дрейф часов), масштаб: 2^-48 секунд/секунда
- **a_f2**: 10 бит (ускорение дрейфа часов), масштаб: 2^-60 секунд/секунда²

Параметры ионосферы:
- **α_0** до **α_3**: Ионосферные альфа-параметры (по 8 бит)
- **β_0** до **β_3**: Ионосферные бета-параметры (по 8 бит)

Групповая задержка:
- **T_GD**: 13 бит (групповая задержка L1-L2), масштаб: 2^-35 секунд
- **ISC_L1CA**: 13 бит (межсигнальная коррекция)
- **ISC_L2C**: 13 бит
- **ISC_L5I5**: 13 бит
- **ISC_L5Q5**: 13 бит

### Тип сообщения 31: Часы и сокращённый альманах

Комбинирует параметры часов с данными сокращённого альманаха.

### Тип сообщения 32: Параметры ориентации Земли (EOP)

- **t_EOP**: 16 бит (время привязки данных EOP)
- **PM_X**: 21 бит (движение полюса X), масштаб: 2^-20 угловых секунд
- **PM_X_dot**: 15 бит (скорость движения полюса X), масштаб: 2^-21 угловых секунд/день
- **PM_Y**: 21 бит (движение полюса Y), масштаб: 2^-20 угловых секунд
- **PM_Y_dot**: 15 бит (скорость движения полюса Y), масштаб: 2^-21 угловых секунд/день
- **ΔUT1**: 31 бит (UT1-UTC), масштаб: 2^-24 секунд
- **ΔUT1_dot**: 19 бит (скорость UT1-UTC), масштаб: 2^-25 секунд/день

### Тип сообщения 33: Часы и параметры UTC

Параметры UTC:
- **A_0-n**: 16 бит (смещение UTC), масштаб: 2^-35 секунд
- **A_1-n**: 13 бит (дрейф UTC), масштаб: 2^-51 секунд/секунда
- **A_2-n**: 7 бит (ускорение дрейфа UTC), масштаб: 2^-68 секунд/секунда²
- **t_ot**: 16 бит (время привязки UTC), масштаб: 2^4 секунд
- **WN_ot**: 13 бит (неделя привязки UTC)

### Тип сообщения 34: Дифференциальная коррекция

Расширенная дифференциальная коррекция для 6 спутников.

### Тип сообщения 35: Смещение времени GPS/GNSS

Смещения времени между GPS и другими GNSS:
- **GGTO ID**: Идентифицирует систему GNSS
- **A_0-GGTO**: 16 бит (смещение времени)
- **A_1-GGTO**: 13 бит (дрейф смещения времени)
- **A_2-GGTO**: 7 бит (ускорение дрейфа смещения времени)
- **t_GGTO**: 16 бит (время привязки)
- **WN_GGTO**: 13 бит (неделя привязки)

### Тип сообщения 36: Сокращённый альманах

Дополнительные данные сокращённого альманаха.

### Тип сообщения 37: Часы и сокращённый альманах

Аналогично MT 31, предоставляет часы и сокращённый альманах.

## Прямое исправление ошибок

CNAV использует свёрточное кодирование со скоростью 1/2:
- **Длина кодового ограничения**: K = 7
- **Порождающие полиномы**: 
  - G1 = 171 (восьмеричная) = 1111001 (двоичная)
  - G2 = 133 (восьмеричная) = 1011011 (двоичная)

## Обнаружение ошибок CRC-24

24-битный CRC использует полином:
```
G(x) = x^24 + x^23 + x^18 + x^17 + x^14 + x^11 + x^10 + x^7 + x^6 + x^5 + x^4 + x^3 + x + 1
```

## Расписание передачи

Сообщения CNAV вещаются согласно определённому расписанию:
- **Сообщения в начале часа**: MT 10, 11, 30 (эфемериды и часы)
- **Переменное расписание**: Другие типы сообщений на основе конфигурации спутника
- **Стандартный шаблон**: Обеспечивает доступность критических данных в течение 48 секунд

### Типичная последовательность передачи
```
Время(с) | 0-12  | 12-24 | 24-36 | 36-48 | 48-60 | ...
MT       |  10   |  11   |  30   | 14/33 | 12/31 | ...
```

## Процесс компоновки сообщения

### Формирование сообщения CNAV
1. **Сборка заголовка**: Преамбула (10001011b) + PRN + тип сообщения + TOW + флаг тревоги
2. **Упаковка данных**: Навигационные параметры упаковываются согласно типу сообщения
3. **Вычисление CRC**: Рассчитывается 24-битный CRC для всего сообщения
4. **Свёрточное кодирование**: Применяется кодирование со скоростью 1/2
5. **Формирование символов**: Кодированные биты группируются в 20-мс символы

### Структура передачи
- Каждое сообщение: 300 бит данных → 600 бит после кодирования
- Передаётся как 600 символов по 20 мс = 12 секунд

## Ключевые улучшения по сравнению с устаревшим NAV

1. **Прямое исправление ошибок**: Улучшает надёжность данных
2. **Гибкая структура сообщений**: Переменные типы сообщений
3. **Расширенная модель часов**: Включает член a_f2
4. **Улучшенные эфемериды**: Дополнительные корректирующие члены
5. **Совместимость GNSS**: Параметры смещения времени
6. **Параметры ориентации Земли**: Для точного позиционирования
7. **Сокращённый альманах**: Более эффективный, чем устаревший формат
8. **Текстовые сообщения**: Возможность вещания предупреждений

## Замечания по реализации

### Процесс декодирования
1. **Битовая синхронизация**: Выравнивание по 20-мс символам
2. **Декодирование Витерби**: Декодирование свёрточного кода
3. **Синхронизация кадра**: Поиск 8-битной преамбулы (10001011)
4. **Проверка CRC**: Проверка целостности сообщения
5. **Разбор типа сообщения**: Извлечение данных на основе MT
6. **Масштабирование параметров**: Применение соответствующих масштабных коэффициентов

### Стратегия сбора данных
Для полного навигационного решения:
1. Собрать MT 10 и 11 для эфемерид (или MT 32)
2. Собрать MT 30 или 33 для параметров часов
3. Опционально: Собрать сообщения альманаха для других спутников
4. Опционально: Собрать MT 32 для EOP при необходимости высокой точности

### Важные соображения

1. **Парность сообщений**: MT 10 и 11 должны иметь совпадающий t_oe
2. **Возраст данных**: Проверять TOW для определения свежести данных
3. **Флаги состояния**: Проверять состояние спутника перед использованием
4. **Ошибки CRC**: Отбрасывать сообщения с ошибками CRC
5. **Непрерывность времени**: Убедиться, что TOW увеличивается монотонно

### Примеры масштабных коэффициентов

Общие масштабные коэффициенты и их применение:
- Время: 2^n секунд (различные n)
- Угол: 2^-n полуокружностей (π радиан = 1 полуокружность)
- Часы: 2^-n секунд или секунд/секунда
- Расстояние: метры (различные масштабы)

## Специальные возможности

### 1. Поддержка целостности
- Множественные параметры URA (точность дальности пользователя)
- Расширенное сообщение о состоянии
- Флаг тревоги для немедленных предупреждений

### 2. Модернизированный альманах
- Формат сокращённого альманаха более эффективен
- Midi альманах (будущая реализация)
- Множественные типы сообщений альманаха

### 3. Совместимость
- GGTO для смещения времени с другими GNSS
- Стандартный формат сообщений на спутниках GPS III
- Совместим с будущим L5 CNAV

### 4. Гибкость
- Переменные типы сообщений позволяют будущее расширение
- Возможность текстовых сообщений для уведомлений
- Зарезервированные типы сообщений для будущего использования