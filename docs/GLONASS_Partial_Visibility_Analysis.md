# Анализ частичной видимости спутников ГЛОНАСС
## Дата: 14 января 2025

## Проблема
После исправления модуляции ГЛОНАСС с правильным XOR и оптимальной полярностью (вариант A+B), приёмники стабильно видят только 2 спутника из 9 (SV03 и SV13).

## Возможные причины

### 1. Разные частотные каналы FDMA
ГЛОНАСС использует FDMA с разными частотами для каждого спутника:
- G1: 1602 МГц + k × 0.5625 МГц
- G2: 1246 МГц + k × 0.4375 МГц

где k - частотный канал от -7 до +6.

**Гипотеза:** Возможно, модуляция работает правильно только для определённых частотных каналов.

### 2. Проблемы с навигационными данными
Разные спутники могут иметь разные:
- Флаги валидности данных
- Параметры в навигационном сообщении
- Статус здоровья спутника

**Проверка:** Посмотреть, что общего у SV03 и SV13 в эфемеридах.

### 3. Проблемы с синхронизацией меандра
Меандр должен быть синхронизирован с границами строк ГЛОНАСС (2 секунды).

**Текущая реализация:**
```cpp
int currentMs = SignalTime.MilliSeconds + (int)(CurChip / 511.0);
int meander = ((currentMs / 10) % 2) ? 0 : 1;
```

**Возможная проблема:** Меандр может быть не синхронизирован с началом строки для некоторых спутников.

### 4. Проблемы с временной меткой
Временная метка передаётся в начале каждой строки (первые 300 мс). Возможно, для некоторых спутников временная метка генерируется неправильно.

### 5. Особенности приёмника
Некоторые приёмники могут:
- Иметь ограничения на количество одновременно отслеживаемых спутников ГЛОНАСС
- Требовать определённый уровень сигнала
- Использовать дополнительные проверки валидности

## Рекомендации для дальнейшего анализа

### 1. Проверить частотные каналы
```bash
# Найти частотные каналы для SV03 и SV13 в эфемеридах
grep -E "R03|R13" ../EphData/rinex_v3_20251560000.rnx
```

### 2. Добавить отладку для всех спутников
Временно изменить условие отладки:
```cpp
if (ChipCount % 51100 == 0) {  // Каждые 100 мс, для всех спутников
    printf("[GLONASS Debug] SV%02d: FreqChannel=%d, Time=%d ms...\n", 
           Svid, FreqChannel, currentMs);
}
```

### 3. Проверить синхронизацию меандра с границами строк
Меандр должен быть синхронизирован с 2-секундными строками:
```cpp
int stringStartMs = (currentMs / 2000) * 2000;
int relativeMs = currentMs - stringStartMs;
int meander = ((relativeMs / 10) % 2) ? 0 : 1;
```

### 4. Проверить навигационные данные
Добавить проверку валидности навигационных данных для каждого спутника.

## Текущий статус
- ✅ Временная метка реализована правильно (0x3E375096)
- ✅ Меандр 100 Гц работает
- ✅ XOR трёх компонентов реализован
- ✅ Оптимальная полярность найдена (A+B)
- ❌ Только 2 из 9 спутников видны стабильно

## Следующие шаги
1. Исследовать, что особенного в SV03 и SV13
2. Проверить синхронизацию меандра с границами строк
3. Добавить расширенную отладку для всех спутников
4. Проверить другие параметры модуляции