# Полная техническая документация Galileo E5a F/NAV

## Содержание
1. [Обзор системы](#обзор-системы)
2. [Характеристики сигнала](#характеристики-сигнала)
3. [Структура навигационного сообщения](#структура-навигационного-сообщения)
4. [Детальное описание страниц](#детальное-описание-страниц)
5. [Кодирование и защита от ошибок](#кодирование-и-защита-от-ошибок)
6. [Модуляция сигнала](#модуляция-сигнала)
7. [Реализация в коде](#реализация-в-коде)
8. [Временные параметры](#временные-параметры)
9. [Проверка и валидация](#проверка-и-валидация)

## Обзор системы

Galileo E5a является одним из сигналов открытой службы (OS) европейской спутниковой навигационной системы Galileo. Сигнал передаёт навигационное сообщение F/NAV (Freely accessible NAVigation), оптимизированное для быстрого времени до первого определения местоположения (TTFF).

### Ключевые преимущества F/NAV:
- Быстрая передача эфемерид (50 секунд для полного набора)
- Эффективное кодирование с защитой от ошибок
- Поддержка одночастотных и многочастотных приёмников
- Совместимость с другими GNSS системами

## Характеристики сигнала

### Основные параметры
| Параметр | Значение |
|----------|----------|
| Несущая частота | 1176.45 МГц |
| Полоса пропускания | 51.15 МГц |
| Модуляция | BPSK(10) |
| Скорость чипов | 10.23 Мчип/с |
| Длина PRN кода | 10230 чипов |
| Период PRN кода | 1 мс |
| Скорость данных | 50 бит/с (25 символов/с после кодирования) |
| Длительность символа | 20 мс |

### Компоненты сигнала
- **Data компонента (E5a-I)**: Передаёт навигационное сообщение F/NAV
- **Pilot компонента (E5a-Q)**: Непрерывный сигнал для слежения

## Структура навигационного сообщения

### Иерархия F/NAV
```
Полное сообщение (600 секунд)
├── 60 Страниц
    ├── Страница (10 секунд)
        ├── Синхрослово (12 символов = 240 мс)
        ├── Закодированные данные (488 символов = 9760 мс)
            ├── Информационные биты (214 бит)
            ├── CRC-24 (24 бита)
            ├── Хвостовые биты (6 бит)
```

### Типы страниц

| Тип | Содержимое | Периодичность |
|-----|------------|---------------|
| 1 | Часы спутника, ионосфера, состояние | 50 с |
| 2 | Эфемериды (часть 1/3) | 50 с |
| 3 | Эфемериды (часть 2/3) | 50 с |
| 4 | Эфемериды (часть 3/3), UTC | 50 с |
| 5 | Альманах, время GST | Переменная |
| 6 | Зарезервировано | - |

## Детальное описание страниц

### Страница типа 1 - Параметры часов и ионосферы

#### Структура битовых полей:
```
Слово 1 (биты 0-31):
[31-26]: Тип страницы (6 бит) = 000001
[25-6]:  TOW - Время недели (20 бит)
[5-0]:   Зарезервировано (6 бит)

Слово 2 (биты 32-63):
[31-22]: IODnav (10 бит)
[21-8]:  t0c - Время привязки часов (14 бит)
[7-2]:   af2 MSB (6 бит)

Слово 3 (биты 64-95):
[31-11]: af1 - Дрейф часов (21 бит)
[10-3]:  Зарезервировано (8 бит)
[2-1]:   E5a HS - Состояние сигнала (2 бита)

Слово 4 (биты 96-127):
[31-1]:  af0 - Смещение часов (31 бит)

Слово 5 (биты 128-159):
[31-21]: ai0 - Ионосферный параметр (11 бит)
[20-10]: ai1 - Ионосферный параметр (11 бит)
[9-0]:   ai2 MSB (10 бит)

Слово 6 (биты 160-191):
[31-28]: ai2 LSB (4 бита)
[27-23]: Флаги регионов (5 бит)
[22-13]: BGD E5a/E1 (10 бит)
[12]:    E5a DVS (1 бит)
[11-0]:  Зарезервировано (12 бит)

Слово 7 (биты 192-213):
[21-0]:  GST-WN и GST-TOW
```

#### Масштабные коэффициенты:
- **t0c**: LSB = 60 секунд
- **af0**: LSB = 2^-34 секунды
- **af1**: LSB = 2^-46 сек/сек
- **af2**: LSB = 2^-59 сек/сек²
- **ai0**: LSB = 0.25 sfu
- **ai1**: LSB = 2^-8 sfu/полуокружность
- **ai2**: LSB = 2^-15 sfu/полуокружность²
- **BGD**: LSB = 2^-32 секунды

### Страница типа 2 - Эфемериды (1/3)

#### Содержимое:
- M0 - Средняя аномалия на момент привязки
- OMEGA_dot - Скорость прецессии восходящего узла
- e - Эксцентриситет орбиты
- √A - Квадратный корень большой полуоси
- OMEGA0 - Долгота восходящего узла
- IDOT - Скорость изменения наклонения

#### Битовые поля:
```
Слово 1: Тип (6) + IODnav (10) + M0_MSB (16)
Слово 2: M0_LSB (16) + OMEGA_dot_MSB (16)
Слово 3: OMEGA_dot_LSB (8) + e_MSB (24)
Слово 4: e_LSB (8) + sqrtA_MSB (24)
Слово 5: sqrtA_LSB (8) + OMEGA0_MSB (24)
Слово 6: OMEGA0_LSB (8) + IDOT (14) + Spare (10)
Слово 7: GST (32)
```

### Страница типа 3 - Эфемериды (2/3)

#### Содержимое:
- i0 - Наклонение на момент привязки
- omega - Аргумент перигея
- Delta_n - Поправка к среднему движению
- Cuc, Cus - Коррекции аргумента широты
- Crc, Crs - Коррекции радиуса
- t0e - Время привязки эфемерид

#### Структура:
```
Слово 1: Тип (6) + IODnav (10) + i0_MSB (16)
Слово 2: i0_LSB (16) + omega_MSB (16)
Слово 3: omega_LSB (16) + Delta_n (16)
Слово 4: Cuc (16) + Cus (16)
Слово 5: Crc (16) + Crs (16)
Слово 6: t0e (14) + Spare (10) + GST_MSB (8)
Слово 7: GST_LSB (24) + Spare (8)
```

### Страница типа 4 - Эфемериды (3/3) и UTC

#### Содержимое:
- Cic, Cis - Коррекции наклонения
- Параметры преобразования GST-UTC
- Параметры смещения GST-GPS

#### Параметры времени GST-UTC:
- **A0**: Смещение (32 бита, LSB = 2^-30 с)
- **A1**: Дрейф (24 бита, LSB = 2^-50 с/с)
- **Tot**: Время привязки (8 бит, LSB = 3600 с)
- **WNot**: Неделя привязки (8 бит)
- **Delta_tLS**: Текущие високосные секунды (8 бит)
- **WN_LSF**: Неделя високосной коррекции (8 бит)
- **DN**: День недели коррекции (3 бита)
- **Delta_tLSF**: Будущие високосные секунды (8 бит)

### Страница типа 5 - Альманах

#### Структура альманаха для трёх спутников:
Каждая страница типа 5 содержит данные альманаха для трёх спутников Galileo.

##### Параметры на спутник:
- **SVID**: ID спутника (6 бит)
- **√A**: Квадратный корень большой полуоси (13 бит, LSB = 2^-9 м^1/2)
- **e**: Эксцентриситет (11 бит, LSB = 2^-16)
- **omega**: Аргумент перигея (16 бит, LSB = 2^-15 полуокружностей)
- **Delta_i**: Поправка наклонения (11 бит, LSB = 2^-14 полуокружностей)
- **OMEGA0**: Долгота восходящего узла (16 бит, LSB = 2^-15 полуокружностей)
- **OMEGA_dot**: Скорость прецессии (11 бит, LSB = 2^-33 полуокружностей/с)
- **M0**: Средняя аномалия (16 бит, LSB = 2^-15 полуокружностей)
- **af0**: Смещение часов (16 бит, LSB = 2^-19 с)
- **af1**: Дрейф часов (13 бит, LSB = 2^-38 с/с)
- **Health**: Состояние спутника (2 бита)

## Кодирование и защита от ошибок

### Свёрточное кодирование
- **Скорость кода**: 1/2
- **Длина кодового ограничения**: K = 7
- **Полиномы генератора**:
  - G1 = 171 (восьмеричное) = 1111001 (двоичное)
  - G2 = 133 (восьмеричное) = 1011011 (двоичное) - инвертирован

### CRC-24Q
Полином: `x^24 + x^23 + x^22 + x^21 + x^20 + x^19 + x^18 + x^17 + x^14 + x^13 + x^11 + x^10 + x^9 + x^8 + x^6 + x^3 + x + 1`

Шестнадцатеричное представление: 0x1864CFB

### Перемежение
- Блочное перемежение 8×61
- 488 закодированных символов записываются по столбцам
- Передаются по строкам

### Синхронизация
Синхрослово (12 символов): `1 0 1 1 0 1 1 1 0 0 0 0`

## Модуляция сигнала

### Схема модуляции E5a
```
                    ┌─────────────┐
   F/NAV данные ───►│ Кодирование ├───► Data PRN ───► BPSK ───┐
                    └─────────────┘                            │
                                                               ▼
                                                         Квадратурный
                                                          сумматор
                                                               ▲
                         Pilot PRN ─────────► BPSK ───────────┘
```

### Квадратурная модуляция
- **I канал (мнимая часть)**: -Data × PRN × 0.7071
- **Q канал (реальная часть)**: Pilot × PRN × 0.7071
- Равное распределение мощности между компонентами

### PRN коды
- **Тип**: Коды Голда
- **Длина**: 10230 чипов
- **Период**: 1 мс
- **Полиномы LFSR**:
  - G1: x^14 + x^10 + x^6 + x + 1
  - G2: x^14 + x^13 + x^12 + x^11 + x^10 + x^9 + x^8 + x^7 + x^2 + x + 1

## Реализация в коде

### Основные классы и файлы

#### FNavBit.h/cpp - Формирование навигационного сообщения
```cpp
class FNavBit : public NavBit {
    // Хранение данных эфемерид для 36 спутников
    unsigned int GalEphData[36][4][7];
    // Хранение данных альманаха
    unsigned int GalAlmData[12][2][7];
    // Параметры UTC и ионосферы
    unsigned int GalUtcData[4];
    unsigned int GalIonoData[2];
};
```

#### Ключевые методы:
1. **GetFrameData()** - Формирует страницу для передачи
2. **SetEphemeris()** - Устанавливает эфемериды спутника
3. **ComposeEphWords()** - Упаковывает эфемериды в биты
4. **GalConvolutionEncode()** - Свёрточное кодирование

### Генерация PRN (PrnGenerate.cpp)
```cpp
// E5a-I (Data)
DataPrn = GetGoldCode(E5aIPrnInit[Svid-1], 0x28d8, 0x3fff, 0x20a1, 10230, 14, 10230);
// E5a-Q (Pilot)  
PilotPrn = GetGoldCode(E5aQPrnInit[Svid-1], 0x28d8, 0x3fff, 0x20a1, 10230, 14, 10230);
```

### Модуляция (SatelliteSignal.cpp)
```cpp
case SIGNAL_INDEX_E5a:
    DataSignal = complex_number(0, -DataBit * AMPLITUDE_1_2);
    PilotSignal = complex_number(PilotBit * AMPLITUDE_1_2, 0);
    break;
```

## Временные параметры

### Синхронизация времени
- **GST (Galileo System Time)**: Основное системное время
- **TOW (Time of Week)**: 0-604799 секунд
- **WN (Week Number)**: 12-битный счётчик недель

### Расписание передачи
```
Время (с) | 0-10 | 10-20 | 20-30 | 30-40 | 40-50 | 50-60 | ...
Страница  |  1   |   2   |   3   |   4   |5(SV1) |   1   | ...
```

### Время до получения данных
- **Эфемериды**: Максимум 50 секунд
- **UTC параметры**: Максимум 50 секунд
- **Полный альманах**: ~10 минут (36 спутников)

## Проверка и валидация

### Проверки целостности
1. **CRC-24**: Обязательная проверка для каждой страницы
2. **IODnav**: Согласованность между страницами эфемерид
3. **Диапазоны параметров**: Валидация физических ограничений
4. **Временные метки**: Проверка актуальности данных

### Индикаторы состояния
- **E5a HS (Health Status)**: 
  - 00: Сигнал OK
  - 01: Сигнал вне службы
  - 10: Сигнал будет вне службы
  - 11: Тестовый режим
- **E5a DVS (Data Validity Status)**:
  - 0: Навигационные данные валидны
  - 1: В процессе обновления

### Рекомендации по обработке ошибок
1. При ошибке CRC отбросить всю страницу
2. При несовпадении IODnav дождаться новых данных
3. Проверять возраст эфемерид (обычно валидны 4 часа)
4. Использовать альманах как резервный источник

## Заключение

Galileo E5a F/NAV представляет собой современную реализацию навигационного сообщения, оптимизированную для:
- Быстрого времени до первого определения местоположения
- Надёжной передачи в сложных условиях приёма
- Совместимости с многочастотными приёмниками
- Эффективного использования полосы пропускания

Реализация в коде полностью соответствует официальной спецификации Galileo OS SIS ICD и обеспечивает корректную генерацию сигнала E5a с навигационным сообщением F/NAV.