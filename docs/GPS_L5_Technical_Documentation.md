# Техническая документация GPS L5

## Обзор сигнала GPS L5

GPS L5 - это третий гражданский сигнал GPS, работающий на частоте 1176.45 МГц. Сигнал разработан для обеспечения высокой точности и надежности, особенно для критически важных приложений.

## Основные характеристики

### Частотные параметры
- **Несущая частота**: 1176.45 МГц (115 × 10.23 МГц)
- **Полоса пропускания**: 24 МГц
- **Частота чипов**: 10.23 МГц

### Структура сигнала
GPS L5 использует QPSK модуляцию с двумя квадратурными компонентами:
- **I5 (In-phase)**: Канал данных с навигационным сообщением
- **Q5 (Quadrature)**: Пилотный канал без данных

### PRN коды
- **Длина кода**: 10230 чипов
- **Период повторения**: 1 мс
- **Тип кода**: Gold коды
- **Полиномы генератора**:
  - G1: x^13 + x^12 + x^10 + x^9 + x^7 + x^6 + x^5 + x^1 + 1 (окт. 0x18ed)
  - G2: x^13 + x^12 + x^11 + x^10 + x^9 + x^8 + x^7 + x^6 + x^5 + x^4 + x^3 + x^2 + x^1 + 1 (окт. 0x1fff)
- **Начальное состояние G2**: 0x1b00
- **Точка сброса**: 8190 (для синхронизации эпох)

## Навигационное сообщение CNAV

### Общая структура
- **Тип сообщения**: CNAV (Civil Navigation)
- **Длина сообщения**: 300 бит
- **Время передачи**: 6 секунд
- **Скорость передачи**: 50 бит/сек (до кодирования)

### Структура сообщения (300 бит)
1. **Преамбула**: 8 бит (10001011)
2. **PRN ID**: 6 бит (номер спутника)
3. **Тип сообщения**: 6 бит
4. **TOW (Time of Week)**: 17 бит
5. **Данные сообщения**: 238 бит (зависит от типа)
6. **CRC-24Q**: 24 бита

### Кодирование
- **Сверточное кодирование**: K=7, r=1/2
- **Выходная длина**: 600 символов (после кодирования)
- **CRC полином**: x^24 + x^23 + x^18 + x^17 + x^14 + x^11 + x^10 + x^7 + x^6 + x^5 + x^4 + x^3 + x + 1

### Типы сообщений CNAV

| Тип | Содержание | Интервал передачи |
|-----|------------|-------------------|
| 10  | Эфемериды (часть 1) | 48 сек |
| 11  | Эфемериды (часть 2) | 48 сек |
| 30  | Ионосфера, UTC, часы | 288 сек |
| 31  | Сокращенный альманах | 288 сек |
| 32  | EOP (Earth Orientation Parameters) | По необходимости |
| 33  | UTC и ионосфера | 288 сек |
| 34  | Дифференциальные коррекции | По необходимости |
| 35  | GPS/GNSS временные смещения | По необходимости |
| 36  | Текстовое сообщение | По необходимости |
| 37  | Альманах MIDI | 144 сек |

## Модуляция сигнала

### QPSK модуляция
- **I5 канал**: Данные (CNAV) × PRN I5 × NH код
- **Q5 канал**: PRN Q5 (только пилот)
- **Относительная мощность**: I5 = -3 дБ, Q5 = -3 дБ (равная мощность)

### Neuman-Hoffman (NH) код
- **Длина**: 10 бит
- **Код**: 0000110101 (0x035 или 0x2b0 в обратном порядке)
- **Период**: 10 мс
- **Применение**: Только на I5 канале

### Фазовые соотношения
В реализации проекта:
```
DataSignal = complex_number(0, DataBit * AMPLITUDE_1_2);    // I5 на мнимой части
PilotSignal = complex_number(PilotBit * AMPLITUDE_1_2, 0);  // Q5 на реальной части
```
где AMPLITUDE_1_2 = 0.7071 (1/√2) для равной мощности.

## Синхронизация и временные метки

### Временная синхронизация
- **Эпоха PRN кода**: Каждую миллисекунду
- **Эпоха NH кода**: Каждые 10 мс
- **Эпоха навигационного бита**: Каждые 20 мс
- **Начало сообщения**: Каждые 6 секунд

### TOW (Time of Week)
- **Разрешение**: 6 секунд
- **Диапазон**: 0-100799 (604800 секунд в неделе / 6)
- **Привязка**: К началу следующего сообщения

## Детальная структура сообщений

### Сообщение типа 10 (Эфемериды часть 1)
Содержит основные параметры орбиты:
- WN (номер недели)
- Здоровье спутника
- toe (время эфемерид)
- Δn (поправка к среднему движению)
- M₀ (средняя аномалия)
- e (эксцентриситет)
- √A (корень большой полуоси)
- ω (аргумент перигея)

### Сообщение типа 11 (Эфемериды часть 2)
Содержит дополнительные параметры:
- Ω₀ (долгота восходящего узла)
- i₀ (наклонение)
- Ω̇ (скорость прецессии)
- i̇ (скорость изменения наклонения)
- Гармонические коррекции (Cis, Cic, Crs, Crc, Cus, Cuc)

### Сообщение типа 30 (Часы, ионосфера, групповые задержки)
- Параметры часов (toc, af0, af1, af2)
- Ионосферные параметры (α₀-α₃, β₀-β₃)
- Групповые задержки (TGD для различных частот)

## Реализация в проекте

### Генерация PRN кодов (PrnGenerate.cpp)
```cpp
case SIGNAL_INDEX_L5:
    DataPrn  = GetGoldCode(L5IPrnInit[Svid-1], 0x18ed, 0x1fff, 0x1b00, 10230, 13, 8190);
    PilotPrn = GetGoldCode(L5QPrnInit[Svid-1], 0x18ed, 0x1fff, 0x1b00, 10230, 13, 8190);
    Attribute = &PrnAttributes[4];
    break;
```

### Формирование сигнала (SatelliteSignal.cpp)
```cpp
case SIGNAL_INDEX_L5:
    DataSignal = complex_number(0, DataBit * AMPLITUDE_1_2);
    PilotSignal = complex_number(PilotBit * AMPLITUDE_1_2, 0);
    break;
```

### NH код (SatelliteSignal.cpp)
```cpp
{1, 10, 0x2b0, 6000}, // index 3 for CNAV L5
```

## Известные проблемы и их анализ

### Проблема
Приёмники не обнаруживают сигнал GPS L5, хотя реализация соответствует спецификации.

### Возможные причины
1. **Фазовые соотношения I/Q**: Возможно неправильное отображение I5/Q5 на комплексные компоненты
2. **Применение NH кода**: Проверить правильность XOR операции с навигационными битами
3. **Синхронизация кодировщика**: Состояние сверточного кодировщика между сообщениями
4. **Уровни мощности**: Проверить соотношение мощностей I5/Q5

### Рекомендации по отладке
1. Записать реальный GPS L5 сигнал и сравнить спектры
2. Проверить декодирование CNAV сообщений независимым декодером
3. Проверить фазовую когерентность I5 и Q5 каналов
4. Убедиться в правильности применения NH кода (побитовое XOR)

## Тестовые конфигурации

### Минимальная конфигурация L5
```json
{
    "duration": 60,
    "sampleRate": 10230000,
    "IF": 0,
    "IQ": 1,
    "signals": {
        "gps": {
            "enable": true,
            "power": -130,
            "dopp": 0,
            "L1CA": {"enable": false},
            "L1C":  {"enable": false},
            "L2C":  {"enable": false},
            "L2P":  {"enable": false},
            "L5":   {"enable": true}
        }
    }
}
```

### Рекомендуемые параметры SDR
- Центральная частота: 1176.45 МГц
- Частота дискретизации: ≥10.23 МГц
- Полоса: ≥24 МГц
- Формат: I/Q (комплексный)

## Ссылки
- IS-GPS-705J: Interface Specification for L5
- GPS ICD Working Group документы
- RTCA DO-261 для авиационных требований