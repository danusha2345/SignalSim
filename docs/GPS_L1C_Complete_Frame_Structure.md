# GPS L1C CNAV-2 Полная структура фрейма и субфреймов

## Общая структура фрейма L1C

### Временные характеристики
- **Длительность фрейма**: 18 секунд
- **Скорость передачи символов**: 100 sps (символов в секунду)
- **Общее количество символов**: 1800
- **Количество битов данных до кодирования**: 900 бит

### Структура фрейма (1800 символов)

| Субфрейм | Биты данных | Символы после LDPC | Описание |
|----------|-------------|-------------------|----------|
| Субфрейм 1 | 9 бит | 52 символа | TOI (Time of Interval) с BCH кодированием |
| Субфрейм 2 | 600 бит | 1200 символов | Эфемериды и часы |
| Субфрейм 3 | 274 бит | 548 символов | Переменные данные |
| **Итого** | **883 бита** | **1800 символов** | |

## Детальная структура субфреймов

### Субфрейм 1: TOI (Time of Interval)
**9 бит данных → BCH(51,8) → 52 символа**

| Бит | Длина | Параметр | Описание |
|-----|-------|----------|----------|
| 0 | 1 | TOI MSB | Старший бит TOI |
| 1-8 | 8 | TOI[7:0] | Младшие 8 бит TOI |

**Расчёт TOI**:
```
page = StartTime.MilliSeconds / 18000  // номер фрейма от начала недели
itow = page / 400                      // время недели в 2-часовых интервалах
toi = page % 400                       // TOI от 0 до 399
```

**BCH кодирование**:
- Используется BCH(51,8) код
- 8 информационных бит → 43 проверочных бита
- Итого: 51 бит + 1 бит MSB = 52 бита

### Субфрейм 2: Эфемериды и параметры часов
**576 бит данных + 24 бита CRC → LDPC(1200,600) → 1200 символов**

#### Битовая структура субфрейма 2:

| Старт | Конец | Длина | Параметр | Масштаб | Единицы | Описание |
|-------|-------|-------|----------|---------|---------|----------|
| 0 | 5 | 6 | PRN | - | - | Номер спутника (1-32) |
| 6 | 16 | 11 | t_op | 300 | сек | Время предсказания передачи данных |
| 17 | 17 | 1 | Health_L1C | - | - | Состояние L1C (бит 8 health) |
| 18 | 22 | 5 | URA_ED | - | - | Индекс точности (зависит от высоты) |
| 23 | 33 | 11 | t_oe | 300 | сек | Опорное время эфемерид |
| 34 | 59 | 26 | ΔA | 2^-9 | м | Отклонение большой полуоси от номинала |
| 60 | 84 | 25 | A_dot | 2^-21 | м/с | Скорость изменения большой полуоси |
| 85 | 101 | 17 | Δn_0 | 2^-44 | полуокр/с | Поправка среднего движения |
| 102 | 124 | 23 | Δn_0_dot | 2^-57 | полуокр/с² | Скорость изменения Δn_0 |
| 125 | 157 | 33 | M_0 | 2^-32 | полуокр | Средняя аномалия на t_oe |
| 158 | 190 | 33 | e | 2^-34 | - | Эксцентриситет |
| 191 | 223 | 33 | ω | 2^-32 | полуокр | Аргумент перигея |
| 224 | 256 | 33 | Ω_0 | 2^-32 | полуокр | Долгота восходящего узла |
| 257 | 289 | 33 | i_0 | 2^-32 | полуокр | Наклонение на t_oe |
| 290 | 306 | 17 | Ω_dot | 2^-44 | полуокр/с | Скорость прямого восхождения |
| 307 | 321 | 15 | i_0_dot | 2^-44 | полуокр/с | Скорость изменения наклонения |
| 322 | 337 | 16 | C_is | 2^-30 | рад | Амплитуда sin поправки наклонения |
| 338 | 353 | 16 | C_ic | 2^-30 | рад | Амплитуда cos поправки наклонения |
| 354 | 377 | 24 | C_rs | 2^-8 | м | Амплитуда sin поправки радиуса |
| 378 | 401 | 24 | C_rc | 2^-8 | м | Амплитуда cos поправки радиуса |
| 402 | 422 | 21 | C_us | 2^-30 | рад | Амплитуда sin поправки аргумента широты |
| 423 | 443 | 21 | C_uc | 2^-30 | рад | Амплитуда cos поправки аргумента широты |
| 444 | 454 | 11 | URA_NED | - | - | Точность (не зависит от высоты) |
| 455 | 480 | 26 | a_f0 | 2^-35 | сек | Смещение часов |
| 481 | 500 | 20 | a_f1 | 2^-48 | сек/сек | Дрейф часов |
| 501 | 510 | 10 | a_f2 | 2^-60 | сек/сек² | Скорость дрейфа часов |
| 511 | 523 | 13 | T_GD | 2^-35 | сек | Групповая задержка L1P(Y)-L1C/A |
| 524 | 536 | 13 | ISC_L1CP | 2^-35 | сек | Межсигнальная коррекция L1C пилот |
| 537 | 549 | 13 | ISC_L1CD | 2^-35 | сек | Межсигнальная коррекция L1C данные |
| 550 | 557 | 8 | WN_op | - | недели | Номер недели GPS (мод 256) |
| 558 | 575 | 18 | Reserved | - | - | Зарезервировано |
| 576 | 599 | 24 | CRC-24Q | - | - | Контрольная сумма |

### Субфрейм 3: Переменные данные
**250 бит данных + 24 бита CRC → LDPC(548,274) → 548 символов**

Субфрейм 3 содержит страницы с различными типами данных:
- **Страница 0**: Параметры ионосферы и UTC
- **Страницы 1-6**: Альманах GPS (по 2 спутника на страницу)
- **Другие страницы**: Текстовые сообщения, дополнительные данные

## Процесс кодирования и модуляции

### 1. Формирование данных
1. Заполнение битовых полей согласно таблицам выше
2. Добавление CRC-24Q к субфреймам 2 и 3
3. BCH кодирование для субфрейма 1

### 2. LDPC кодирование
- Субфрейм 1: BCH(51,8) - уже закодирован
- Субфрейм 2: LDPC(1200,600) - rate 1/2
- Субфрейм 3: LDPC(548,274) - rate 1/2

### 3. Интерливинг
После LDPC кодирования выполняется интерливинг:
```
for (i = 0; i < 46; i++)
    for (j = 0; j < 38; j++)
        output[i*38+j] = input[j*46+i]
```

### 4. Модуляция
- **Канал данных**: BOC(1,1) - 25% мощности
- **Пилот-канал**: TMBOC(6,1,4/33) - 75% мощности
- **Вторичный код пилота**: 1800 символов (код Легандра)

## План полной проверки L1C

### Этап 0: Компиляция с отладкой
```bash
# Компиляция с флагом DEBUG_L1C
make clean
make CFLAGS="-O3 -Wall -DDEBUG_L1C"

# Или использовать готовый скрипт
./run_l1c_debug.sh
```

### Этап 1: Проверка формирования навигационного сообщения
1. Вывести в лог все заполненные поля субфрейма 2
2. Проверить правильность масштабирования всех параметров
3. Убедиться, что PRN действительно записывается в биты 0-5
4. Проверить расчёт и кодирование TOI

### Этап 2: Проверка битовой упаковки
1. Вывести побитово содержимое всех 18 DWORD субфрейма 2
2. Сравнить с ожидаемыми значениями согласно документации
3. Проверить порядок бит (MSB first)

### Этап 3: Проверка кодирования
1. Проверить CRC-24Q для субфреймов 2 и 3
2. Проверить LDPC кодирование (матрицы генератора)
3. Проверить интерливинг

### Этап 4: Проверка модуляции
1. Проверить генерацию PRN кодов L1C
2. Проверить вторичный код (1800 символов)
3. Проверить модуляцию BOC(1,1) и TMBOC
4. Проверить распределение мощности (25%/75%)

### Этап 5: Проверка синхронизации
1. Проверить выравнивание по времени
2. Проверить фазы несущей
3. Проверить доплеровские сдвиги

## Критические точки для проверки

1. **PRN в субфрейме 2** - ОБЯЗАТЕЛЬНО должен быть первым!
2. **URA_NED** - должен быть заполнен (хотя бы нулями)
3. **Правильный расчёт TOI** - зависит от времени
4. **CRC должен покрывать 576 бит** субфрейма 2, не больше
5. **Вторичный код** - 1800 символов, не 1800 бит!